<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DDM → ForeFlight (Decimal Minutes) Converter</title>

  <!-- PWA-friendly (keeps existing files working if present) -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b3d91">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">

  <style>
    :root { --bg:#ffffff; --text:#111; --muted:#666; --accent:#0b3d91; --border:#e5e7eb; --card:#fafafa; }
    html, body {height:100%}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);line-height:1.35}
    header{padding:28px 16px 8px}
    h1{margin:0 0 6px;font-size:28px;font-weight:800;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:14px}
    .container{padding:8px 16px 32px;max-width:820px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
    textarea,input[type="text"]{width:100%;box-sizing:border-box;padding:12px;border-radius:10px;border:1px solid var(--border);font-size:16px;background:#fff}
    textarea{min-height:140px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1}
    .btn{appearance:none;border:1px solid var(--border);border-radius:10px;background:#fff;padding:12px 14px;font-size:16px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .out{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;background:#fff;border-radius:10px;border:1px solid var(--border);padding:12px;font-size:16px;min-height:48px;display:flex;align-items:center;justify-content:space-between;gap:8px;white-space:pre-wrap}
    .pill{display:inline-block;background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}
    .hint{color:var(--muted);font-size:13px}
    .examples{margin-top:10px}
    .examples code{background:#11111108;padding:3px 6px;border-radius:6px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .footer{color:var(--muted);font-size:12px;margin-top:24px}
  </style>
</head>
<body>
  <header>
    <h1>DDM → ForeFlight Converter <span class="pill">offline-ready</span></h1>
    <div class="sub">Paste <strong>any common coordinate format</strong> (DD, DDM, DMS) and get a
      <strong>ForeFlight-ready</strong> Degrees &amp; Decimal Minutes string.</div>
  </header>

  <div class="container">
    <div class="card">
      <label for="in" class="hint">Input (any format). One point per line or separated by commas.</label>
      <textarea id="in" placeholder="Examples:
47.6205, -122.3493
47° 37.230' N, 122° 20.958' W
N47° 37' 13.8&quot;  W122° 20' 57.5&quot;
43° 00.100' N 122° 22.40' W"></textarea>

      <div class="row" style="margin-top:10px">
        <button id="convert" class="btn primary" type="button">Convert</button>
        <button id="clear" class="btn" type="button">Clear</button>
        <button id="copy" class="btn" type="button">Copy Output</button>
      </div>

      <div style="margin-top:12px">
        <div class="hint">Output (ForeFlight DDM):</div>
        <div class="out"><span id="out"></span><span id="status" class="hint"></span></div>
      </div>

      <div class="examples hint">
        <div><strong>Tips:</strong> Works with “N/S/E/W”, signs (+/-), symbols (° ' "), or plain numbers.</div>
        <div>Format used: <code>DD° MM.mmm' N/S  DDD° MM.mmm' E/W</code></div>
      </div>
    </div>

    <div class="footer">
      If you saved this to your Home Screen, it will work without internet after the first open.
    </div>
  </div>

  <!-- Script placed at the very end so elements exist before we bind events -->
  <script>
    // --- Service worker registration ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').catch(() => {});
    }

    // Utilities
    function $(id){ return document.getElementById(id); }
    function status(msg){ $('status').textContent = msg || ''; }

    // Bind events after DOM is fully parsed (extra safety even though script is at end)
    document.addEventListener('DOMContentLoaded', () => {
      const inEl = $('in');
      const outEl = $('out');

      $('convert').addEventListener('click', () => {
        try {
          const raw = (inEl.value || '').trim();
          if (!raw) { outEl.textContent = ''; status(''); return; }
          const res = convertMulti(raw);
          outEl.textContent = res.text;
          status(res.note);
        } catch (e) {
          status('Error converting.'); 
          console.error(e);
        }
      });

      $('clear').addEventListener('click', () => {
        inEl.value = '';
        outEl.textContent = '';
        status('Cleared.');
      });

      $('copy').addEventListener('click', async () => {
        const text = (outEl.textContent || '').trim();
        if (!text) return status('Nothing to copy.');
        try {
          await navigator.clipboard.writeText(text);
          status('Copied.');
        } catch {
          status('Copy failed.');
        }
      });
    });

    // ---------- Conversion logic (simplified & safe) ----------
    function convertMulti(raw){
      // Split by newlines; also accept commas separating lat/lon on each line
      const lines = raw.split(/\\n+/).map(s => s.trim()).filter(Boolean);
      const outputs = [];
      for (const line of lines) {
        const pair = splitLatLon(line);
        if (!pair) { outputs.push('⚠️ Could not detect lat/lon in: ' + line); continue; }

        const lat = parseAny(pair.lat);
        const lon = parseAny(pair.lon);
        if (lat == null || lon == null || !isFinite(lat) || !isFinite(lon)) {
          outputs.push('⚠️ Could not parse: ' + line);
          continue;
        }
        outputs.push(toDDM(lat, lon));
      }
      return { text: outputs.join('\\n'), note: outputs.length > 1 ? (outputs.length + ' lines converted') : 'Ready' };
    }

    // Try to split "lat, lon" from a line
    function splitLatLon(line){
      // 1) Common case: explicit comma separating two chunks
      const comma = line.split(/,(?![^()]*\\))/).map(s => s.trim()).filter(Boolean);
      if (comma.length === 2) return { lat: comma[0], lon: comma[1] };

      // 2) If both cardinals present, pull by N/S and E/W areas
      const latCard = line.match(/([NS]\\s*[^NSEW,]+\\d[^NSEW,]*\\s*[NS]?)/i);
      const lonCard = line.match(/([EW]\\s*[^NSEW,]+\\d[^NSEW,]*\\s*[EW]?)/i);
      if (latCard && lonCard) return { lat: latCard[1], lon: lonCard[1] };

      // 3) Fallback: find two coordinate-looking groups (numbers with optional ° ' ")
      const groups = line.match(/([+\\-NSWE\\s]*\\d+(?:[\\.,]\\d+)?(?:[^\\d\\w]+\\d+(?:[\\.,]\\d+)?(?:[^\\d\\w]+\\d+(?:[\\.,]\\d+)?)?)?\\s*[NSWE]?)/gi);
      if (groups && groups.length >= 2) return { lat: groups[0], lon: groups[1] };

      return null;
    }

    // Parse a single coord string to decimal degrees
    function parseAny(str){
      let s = String(str).trim().toUpperCase();
      let hemi = null;
      const hemiMatch = s.match(/[NSEW]/g);
      if (hemiMatch) hemi = hemiMatch[hemiMatch.length - 1]; // last letter wins
      s = s.replace(/[NSEW]/g, ' ');

      // Normalize separators and signs
      s = s.replace(/[°º]/g, ' ').replace(/[′’']/g, ' ').replace(/[″”"]/g, ' ');
      s = s.replace(/,/g, '.').replace(/\\s+/g, ' ').trim();

      // Extract up to 3 numeric parts
      const parts = s.split(' ').filter(Boolean).map(Number).filter(v => !Number.isNaN(v));

      let dd = null;
      if (parts.length === 1) { // DD
        dd = parts[0];
      } else if (parts.length === 2) { // DDM
        dd = parts[0] + parts[1] / 60;
      } else if (parts.length >= 3) { // DMS
        dd = parts[0] + parts[1] / 60 + parts[2] / 3600;
      } else {
        return null;
      }

      if (hemi === 'S' || hemi === 'W') dd = -Math.abs(dd);
      return dd;
    }

    // Convert decimal degrees to DDM string (ForeFlight style)
    function toDDM(lat, lon){
      const latDDM = ddToDDM(Math.abs(lat), true);
      const lonDDM = ddToDDM(Math.abs(lon), false);
      const latH = lat >= 0 ? 'N' : 'S';
      const lonH = lon >= 0 ? 'E' : 'W';
      return `${latDDM} ${latH}  ${lonDDM} ${lonH}`;
    }

    function ddToDDM(dd, isLat){
      const deg = Math.floor(dd);
      const min = (dd - deg) * 60;
      const d = isLat ? String(deg).padStart(2, '0') : String(deg).padStart(3, '0');
      return `${d}° ${min.toFixed(3)}'`;
    }
  </script>
</body>
</html>
