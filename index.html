<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Any → ForeFlight (DDM)</title>
  <meta name="description" content="Paste any common coordinates (DD, DDM, DMS) and convert to ForeFlight-friendly DDM." />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b3d91">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">
  <style>
    :root { --bg:#f6f7fb; --ink:#0b2149; --muted:#5a6b8a; --brand:#123bde; --panel:#fff; --ok:#0f8b2c; --warn:#b8860b; }
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:780px;margin:22px auto;padding:0 16px}
    h1{font-size:28px;margin:8px 0 6px}
    .chip{display:inline-block;font-size:12px;padding:.2rem .55rem;border-radius:999px;background:#eaf0ff;color:#2441ff;margin-left:.5rem;vertical-align:3px}
    .badge{display:inline-flex;gap:6px;align-items:center;font-size:12px;padding:.25rem .55rem;border-radius:999px;background:#e7f9ec;color:#0a6b22;margin-left:.5rem}
    .sub{color:var(--muted);line-height:1.35;margin:6px 0 10px}
    ul{margin:.25rem 0 .5rem 1.1rem;color:var(--muted)}
    textarea, .out {width:100%;box-sizing:border-box;border:1px solid #dbe1f1;border-radius:12px;background:var(--panel);font-size:16px;line-height:1.35;padding:14px 14px;resize:vertical;min-height:140px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:14px 0}
    button{appearance:none;border:0;border-radius:12px;padding:14px 18px;font-weight:600;cursor:pointer}
    .primary{background:var(--brand);color:#fff}
    .ghost{background:#edf1ff;color:#1a34c9}
    .soft{background:#eef2f9;color:#2b3b59}
    .mut{background:#eef2f9;color:#384860}
    .panel{background:var(--panel);border:1px solid #e2e7f3;border-radius:14px;padding:10px 12px}
    .status{border-left:6px solid var(--warn);padding:10px 12px;border-radius:12px;background:#fff8e6;white-space:pre-wrap}
    .stats{color:var(--muted);font-size:13px;margin-top:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .footer{color:#8aa; font-size:12px; margin:22px 2px}
    details summary{cursor:pointer;font-weight:600}
    .tips li{margin:.25rem 0}
    .ok{color:#0a6b22;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Any → ForeFlight (DDM)
      <span class="chip">auto-detect</span>
      <span class="badge">✔ offline ready · v1.9.1</span>
    </h1>
    <div class="sub">
      Paste any common format (DD, DDM, DMS) with N/S/E/W or ± signs. One pair per line. Output is ForeFlight-ready DDM like
      <span class="mono">46 37.230 N, 122 20.958 W</span>.
      <ul class="mono">
        <li>46.6205, -122.3493</li>
        <li>N46° 37.230', W122° 20.958'</li>
        <li>46 37 13.8 N, 122 20 57.5 W</li>
        <li>46 37.230  -122 20.958</li>
        <li>N46.6205  W122.3493</li>
      </ul>
    </div>

    <textarea id="inp" placeholder="Paste coordinates here..."></textarea>

    <div class="row">
      <button class="primary" id="btnConvert">Convert</button>
      <button class="ghost" id="btnCopy">Copy output</button>
      <button class="soft" id="btnTest">Paste test set</button>
      <button class="mut" id="btnClear">Clear</button>
    </div>

    <div class="panel">
      <pre id="out" class="out mono" aria-live="polite"></pre>
      <div id="stats" class="stats"></div>
    </div>

    <details class="panel" style="margin-top:12px">
      <summary>📲 Tips: Add to Home Screen (works offline)</summary>
      <div class="sub">
        <ul class="tips">
          <li><strong>iPhone/iPad (Safari):</strong> Tap <em>Share</em> → <em>Add to Home Screen</em>. Open from the icon. It will cache and work offline.</li>
          <li><strong>Android (Chrome):</strong> ⋮ menu → <em>Install app</em> or <em>Add to Home screen</em>.</li>
          <li>When you see <span class="ok">✔ offline ready</span>, the service worker is active. If you update files, refresh twice to get the new version.</li>
        </ul>
      </div>
    </details>

    <div class="footer">
      Built for helicopter pilots—fast paste → clean DDM output. No data leaves your device.
    </div>
  </div>

<script>
(function(){

  const inp = document.getElementById('inp');
  const out = document.getElementById('out');
  const stats = document.getElementById('stats');

  function ddToDDM(dd, isLat) {
    const sign = dd < 0 ? -1 : 1;
    dd = Math.abs(dd);
    const deg = Math.floor(dd);
    const min = (dd - deg) * 60;
    const hemi = isLat ? (sign < 0 ? 'S' : 'N') : (sign < 0 ? 'W' : 'E');
    return {deg, min, hemi};
  }

  function dmsToDDM(deg, min, sec, hemi, isLat) {
    const sign = (hemi||'').toUpperCase();
    const signed = (sign==='S' || sign==='W') ? -1 : 1;
    const total = Math.abs(deg) + Math.abs(min)/60 + Math.abs(sec)/3600;
    const ddm = ddToDDM(total * signed, isLat);
    return ddm;
  }

  function clampDeg(deg, isLat) {
    const max = isLat ? 90 : 180;
    return Math.min(Math.max(deg, 0), max);
  }

  function formatDDM({deg, min, hemi}, isLat) {
    const d = clampDeg(deg, isLat);
    const m = Math.round(min * 1000) / 1000; // 3 decimals
    return `${d} ${m.toFixed(3)} ${hemi}`;
  }

  // Regexes
  // DD with signs or hemispheres: "46.62, -122.34" or "N46.62 W122.34"
  const reDD = /([NS])?\s*(-?\d+(?:\.\d+)?)\s*[,\s]+([EW])?\s*(-?\d+(?:\.\d+)?)/i;

  // DDM: "46 37.230 N, 122 20.958 W" or with symbols
  const reDDM = /(\d{1,3})[°\s]+(\d+(?:\.\d+)?)['′]?\s*([NS])?\s*[,\s]+(\d{1,3})[°\s]+(\d+(?:\.\d+)?)['′]?\s*([EW])?/i;

  // DMS: "46 37 13.8 N, 122 20 57.5 W" (symbols optional)
  const reDMS = /(\d{1,3})[°\s]+(\d{1,2})[′'\s]+(\d+(?:\.\d+)?)[″"\s]*([NS])?\s*[,\s]+(\d{1,3})[°\s]+(\d{1,2})[′'\s]+(\d+(?:\.\d+)?)[″"\s]*([EW])?/i;

  function parseLine(line) {
    const s = line.trim()
      .replace(/[;|]+/g, ' ')
      .replace(/\s{2,}/g, ' ');

    if (!s) return {type:'empty'};

    // Try DMS first (most specific)
    let m = s.match(reDMS);
    if (m) {
      const lat = dmsToDDM(parseFloat(m[1]), parseFloat(m[2]), parseFloat(m[3]), m[4]||'N', true);
      const lon = dmsToDDM(parseFloat(m[5]), parseFloat(m[6]), parseFloat(m[7]), m[8]||'E', false);
      return {type:'dms', lat, lon};
    }

    // Then DDM
    m = s.match(reDDM);
    if (m) {
      const lat = {deg: parseFloat(m[1]), min: parseFloat(m[2]), hemi: (m[3]||'N').toUpperCase()};
      const lon = {deg: parseFloat(m[4]), min: parseFloat(m[5]), hemi: (m[6]||'E').toUpperCase()};
      return {type:'ddm', lat, lon};
    }

    // Finally DD
    m = s.match(reDD);
    if (m) {
      // Allow hemispheres OR signs
      let lat = parseFloat(m[2]);
      let lon = parseFloat(m[4]);
      if (m[1]) lat = (m[1].toUpperCase()==='S') ? -Math.abs(lat) : Math.abs(lat);
      if (m[3]) lon = (m[3].toUpperCase()==='W') ? -Math.abs(lon) : Math.abs(lon);
      const latD = ddToDDM(lat, true);
      const lonD = ddToDDM(lon, false);
      return {type:'dd', lat: latD, lon: lonD};
    }

    return {type:'error', reason:'Parse error'};
  }

  function convertAll(text) {
    const lines = text.split(/\r?\n/);
    let ok = 0, skipped = 0, outLines = [], notes = [];
    for (const line of lines) {
      const r = parseLine(line);
      if (r.type === 'empty') { skipped++; continue; }
      if (r.type === 'error') { 
        notes.push(`⚠️ Parse error:  ${line}`); 
        skipped++; 
        continue; 
      }
      const latStr = formatDDM(r.lat, true);
      const lonStr = formatDDM(r.lon, false);
      outLines.push(`${latStr}, ${lonStr}`);
      ok++;
    }
    return {text: outLines.join('\n'), ok, skipped, notes};
  }

  function setOutput(res) {
    out.textContent = res.text + (res.notes.length ? 
      (res.text ? '\n\n' : '') + res.notes.join('\n') : '');
    stats.textContent = `${res.ok} converted, ${res.skipped} skipped — ${(res.ok+res.skipped)} line(s) processed.`;
  }

  // Buttons
  document.getElementById('btnConvert').addEventListener('click', () => {
    setOutput(convertAll(inp.value));
  });
  document.getElementById('btnCopy').addEventListener('click', async () => {
    try { await navigator.clipboard.writeText(out.textContent); stats.textContent = 'Copied output.'; }
    catch(e) { stats.textContent = 'Copy failed.'; }
  });
  document.getElementById('btnTest').addEventListener('click', () => {
    inp.value = [
      "46.6205, -122.3493",
      "N46° 37.230', W122° 20.958'",
      "46 37 13.8 N, 122 20 57.5 W",
      "46 37.230  -122 20.958",
      "N46.6205  W122.3493"
    ].join("\n");
  });
  document.getElementById('btnClear').addEventListener('click', () => { inp.value=''; setOutput({text:'',ok:0,skipped:0,notes:[]}); });

  // Auto register SW
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js?v=1.9.1').catch(console.error);
    });
  }
})();
</script>
</body>
</html>
