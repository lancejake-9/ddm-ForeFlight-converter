<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DDM → ForeFlight (Decimal Minutes) Converter</title>

  <!-- PWA-friendly (keeps existing files working if present) -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b3d91">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">

  <style>
    :root {
      --bg: #ffffff;
      --text: #111;
      --muted: #666;
      --accent: #0b3d91;
      --border: #e5e7eb;
      --card: #fafafa;
    }
    html, body {height: 100%;}
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      line-height: 1.35;
    }
    header {
      padding: 28px 16px 8px;
    }
    h1 {
      margin: 0 0 6px;
      font-size: 28px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .sub {
      color: var(--muted);
      font-size: 14px;
    }
    .container {
      padding: 8px 16px 32px;
      max-width: 820px;
      margin: 0 auto;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
    }
    textarea, input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 16px;
      outline: none;
      background: #fff;
    }
    textarea {
      min-height: 140px;
      resize: vertical;
    }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .row > * { flex: 1; }
    .btn {
      appearance: none;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      padding: 12px 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .out {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background: #fff;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 12px;
      font-size: 16px;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .pill {
      display: inline-block;
      background: #eef2ff;
      color: #1e3a8a;
      border: 1px solid #c7d2fe;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      margin-left: 6px;
    }
    .hint { color: var(--muted); font-size: 13px; }
    .examples { margin-top: 10px; }
    .examples code {
      background: #11111108;
      padding: 3px 6px;
      border-radius: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    .footer { color: var(--muted); font-size: 12px; margin-top: 24px; }
  </style>
</head>
<body>
  <header>
    <h1>DDM → ForeFlight Converter <span class="pill">offline-ready</span></h1>
    <div class="sub">Paste <strong>any common coordinate format</strong> (DD, DDM, DMS) and get a
      <strong>ForeFlight-ready</strong> Degrees &amp; Decimal Minutes string.</div>
  </header>

  <div class="container">
    <div class="card">
      <label for="in" class="hint">Input (any format). One point per line or separated by commas.</label>
      <textarea id="in" placeholder="Examples:
47.6205, -122.3493
47°36' , 122°20.958'W
N47° 36'  , W122° 20' 57.5&quot;
43° 00.100' N 122° 22.40' W"></textarea>

      <div class="row" style="margin-top:10px">
        <button id="convert" class="btn primary">Convert</button>
        <button id="clear" class="btn">Clear</button>
        <button id="copy" class="btn">Copy Output</button>
      </div>

      <div style="margin-top:12px">
        <div class="hint">Output (ForeFlight DDM):</div>
        <div class="out"><span id="out"></span><span id="status" class="hint"></span></div>
      </div>

      <div class="examples hint">
        <div><strong>Tips:</strong> Works with “N/S/E/W”, signs (+/-), symbols (° ' "), or plain numbers.</div>
        <div>Format used: <code>DD° MM.mmm' N/S  DDD° MM.mmm' E/W</code></div>
      </div>
    </div>

    <div class="footer">
      If you saved this to your Home Screen, it will work without internet after the first open.
    </div>
  </div>

  <script>
    // --- Service worker registration (quietly ignores if file is missing) ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').catch(() => {});
    }

    // --------- Coordinate parsing & formatting ----------
    const inEl = document.getElementById('in');
    const outEl = document.getElementById('out');
    const statusEl = document.getElementById('status');
    const btnConvert = document.getElementById('convert');
    const btnCopy = document.getElementById('copy');
    const btnClear = document.getElementById('clear');

    btnConvert.addEventListener('click', () => {
      const raw = inEl.value.trim();
      if (!raw) { outEl.textContent = ''; status(''); return; }
      const res = convertMulti(raw);
      outEl.textContent = res.text;
      status(res.note);
    });

    btnClear.addEventListener('click', () => {
      inEl.value = '';
      outEl.textContent = '';
      status('');
    });

    btnCopy.addEventListener('click', async () => {
      const text = outEl.textContent.trim();
      if (!text) return status('Nothing to copy.');
      try {
        await navigator.clipboard.writeText(text);
        status('Copied.');
      } catch {
        status('Copy failed.');
      }
    });

    function status(msg){ statusEl.textContent = msg || ''; }

    function convertMulti(raw){
      // Split into candidate lines; also allow single-line with comma
      const lines = raw
        .split(/\\n+/)
        .map(s => s.trim())
        .filter(Boolean);

      const outputs = [];
      for (const line of lines) {
        const pair = splitLatLon(line);
        if (!pair) { outputs.push('⚠️ Could not detect lat/lon in: ' + line); continue; }

        const lat = parseAny(pair.lat);
        const lon = parseAny(pair.lon);
        if (lat == null || lon == null) {
          outputs.push('⚠️ Could not parse: ' + line);
          continue;
        }
        const ddm = toDDM(lat, lon);
        outputs.push(ddm);
      }

      return { text: outputs.join('\\n'), note: outputs.length > 1 ? (outputs.length + ' lines converted') : 'Ready' };
    }

    // Try to split a line into {lat, lon}
    function splitLatLon(line){
      // If contains both N/S and E/W, split around them
      // Otherwise, try splitting on comma or whitespace blocks
      // 1) Fast path: look for two numeric-ish chunks
      const candidates = line
        .replace(/\\s+/g, ' ')
        .replace(/;|\\|/g, ',')
        .split(/,(?![^()]*\\))/) // commas not inside parentheses
        .map(s => s.trim())
        .filter(Boolean);

      if (candidates.length === 2) {
        return { lat: candidates[0], lon: candidates[1] };
      }

      // Try space split – find two chunks that look coordinate-y
      const nums = line.match(/([NS\\-+]?\\s*\\d+(?:[\\.,]\\d+)?(?:[^\\d\\w]+\\d+(?:[\\.,]\\d+)?(?:[^\\d\\w]+\\d+(?:[\\.,]\\d+)?)?)?\\s*[NSEW]?)/gi);
      if (nums && nums.length >= 2) {
        return { lat: nums[0], lon: nums[1] };
      }

      // Final attempt: extract by cardinal letters
      const latMatch = line.match(/([NS]?\\s*[-+]?\\s*\\d[^NSEW,]*\\s*[NS])/i);
      const lonMatch = line.match(/([EW]?\\s*[-+]?\\s*\\d[^NSEW,]*\\s*[EW])/i);
      if (latMatch && lonMatch) {
        return { lat: latMatch[1], lon: lonMatch[1] };
      }

      return null;
    }

    // Parse any single coordinate (lat or lon) to decimal degrees
    function parseAny(str){
      let s = String(str).trim().toUpperCase();

      // Extract hemisphere and sign
      let hemi = null;
      if (/[NSEW]/.test(s)) {
        const m = s.match(/[NSEW]/);
        hemi = m ? m[0] : null;
        s = s.replace(/[NSEW]/g, ' ').trim();
      }

      let sign = 1;
      if (/^-/.test(s)) sign = -1;
      s = s.replace(/[+\\-]/g, ' ').replace(/\\s+/g, ' ').trim();

      // Normalize degree/min/sec separators
      s = s.replace(/[°º]/g, ' ').replace(/[′’']/g, ' ').replace(/[″”"]/g, ' ');
      s = s.replace(/\\s+/g, ' ').trim();

      const parts = s.split(' ').map(x => x.replace(',', '.')).filter(Boolean);

      // Try DD
      if (parts.length === 1 && isFiniteNum(parts[0])) {
        let dd = parseFloat(parts[0]);
        if (hemi === 'S' || hemi === 'W') dd = -Math.abs(dd);
        dd = dd * sign;
        return dd;
      }

      // Try DDM: D MM.mmm
      if (parts.length === 2 && parts.every(isFiniteNum)) {
        let deg = parseFloat(parts[0]);
        let min = parseFloat(parts[1]);
        let dd = deg + (min / 60);
        if (hemi === 'S' || hemi === 'W') dd = -Math.abs(dd);
        dd = dd * sign;
        return dd;
      }

      // Try DMS: D M S(.s)
      if (parts.length >= 3 && parts.slice(0,3).every(isFiniteNum)) {
        let deg = parseFloat(parts[0]);
        let min = parseFloat(parts[1]);
        let sec = parseFloat(parts[2]);
        let dd = deg + (min / 60) + (sec / 3600);
        if (hemi === 'S' || hemi === 'W') dd = -Math.abs(dd);
        dd = dd * sign;
        return dd;
      }

      return null;
    }

    function isFiniteNum(x){ return x !== '' && isFinite(Number(x)); }

    // Convert decimal degrees to DDM string (ForeFlight style)
    function toDDM(lat, lon){
      const latDDM = ddToDDM(Math.abs(lat), true);
      const lonDDM = ddToDDM(Math.abs(lon), false);
      const latH = lat >= 0 ? 'N' : 'S';
      const lonH = lon >= 0 ? 'E' : 'W';
      // Format: DD° MM.mmm' N  DDD° MM.mmm' W
      return `${latDDM} ${latH}  ${lonDDM} ${lonH}`;
    }

    function ddToDDM(dd, isLat){
      const deg = Math.floor(dd);
      const min = (dd - deg) * 60;
      // 3 decimal minutes is typically fine for ForeFlight
      const minStr = min.toFixed(3);
      const d = isLat ? String(deg).padStart(2, '0') : String(deg).padStart(3, '0');
      return `${d}° ${minStr}'`;
    }
  </script>
</body>
</html>
